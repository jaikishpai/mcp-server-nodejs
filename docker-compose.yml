version: '3.8'

services:
  # MCP Oracle Server - HTTP-based MCP server
  mcp-oracle:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-oracle-server
    environment:
      # Oracle Database Configuration
      - ORACLE_USER=${ORACLE_USER}
      - ORACLE_PASS=${ORACLE_PASS}
      - ORACLE_CONN=${ORACLE_CONN}
      
      # Oracle Connection Pool Configuration
      - ORACLE_POOL_MIN=${ORACLE_POOL_MIN:-2}
      - ORACLE_POOL_MAX=${ORACLE_POOL_MAX:-10}
      - ORACLE_POOL_INCREMENT=${ORACLE_POOL_INCREMENT:-1}
      - ORACLE_POOL_TIMEOUT=${ORACLE_POOL_TIMEOUT:-60}
      - ORACLE_QUEUE_TIMEOUT=${ORACLE_QUEUE_TIMEOUT:-60000}
      
      # NL2SQL Service Configuration
      - NL2SQL_URL=http://nl2sql-service:8500/query
      
      # Web Server Configuration
      - PORT=3000
      - ENABLE_WEB_SERVER=true
      
      # MCP Configuration
      - MCP_API_KEY=${MCP_API_KEY}
      - MCP_REQUEST_TIMEOUT=${MCP_REQUEST_TIMEOUT:-30000}
      
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # CORS Configuration
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      
      # Request Size Limit
      - MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE:-10mb}
    volumes:
      - ./logs:/app/logs
    ports:
      - "${PORT:-3000}:3000"
    networks:
      - backend
    restart: always
    depends_on:
      - nl2sql-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # NL2SQL FastAPI Service (Placeholder)
  # Replace this with your actual NL2SQL service image
  nl2sql-service:
    image: python:3.10-slim
    container_name: nl2sql-service
    working_dir: /app
    command: >
      sh -c "
        pip install --no-cache-dir fastapi uvicorn pydantic &&
        python -c \"
from fastapi import FastAPI
from pydantic import BaseModel
import uvicorn

app = FastAPI(title='NL2SQL Service', version='1.0.0')

class QueryRequest(BaseModel):
    query: str

@app.post('/query')
async def query(request: QueryRequest):
    # Placeholder implementation - replace with your actual NL2SQL logic
    return {
        'sql': f'SELECT * FROM table WHERE description LIKE \\'%{request.query}%\\'',
        'explanation': 'This is a placeholder NL2SQL service. Replace with your actual implementation.',
        'confidence': 0.5
    }

@app.get('/health')
async def health():
    return {'status': 'ok', 'service': 'nl2sql-service'}

if __name__ == '__main__':
    uvicorn.run(app, host='0.0.0.0', port=8500)
        \"
      "
    ports:
      - "8500:8500"
    networks:
      - backend
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Oracle Database (Optional - for local testing only)
  # Uncomment and configure if you want to run a local Oracle instance
  # Note: This uses gvenzl/oracle-free which is suitable for development/testing
  # For production, use a managed Oracle database service
  # oracle-db:
  #   image: gvenzl/oracle-free:latest
  #   container_name: oracle-db
  #   environment:
  #     - ORACLE_PASSWORD=${ORACLE_DB_PASSWORD:-oracle}
  #   ports:
  #     - "1521:1521"
  #   networks:
  #     - backend
  #   restart: always
  #   volumes:
  #     - oracle-data:/opt/oracle/oradata
  #   healthcheck:
  #     test: ["CMD", "healthcheck.sh"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 10
  #     start_period: 120s

networks:
  backend:
    driver: bridge

volumes:
  oracle-data:
